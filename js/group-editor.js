jQuery(document).ready(function(c){var m=c("#group-member-list");c("a.nav-link").click(function(a){a.preventDefault();var a=c("a.nav-tab[href="+this.hash+"]"),b=c(this.hash);$input=b.hasClass("group-panel")?c("#tab"):c("#perm_panel");$input.val(a.data("target"));a.addClass("nav-tab-active").siblings().removeClass("nav-tab-active");b.addClass("active").siblings().removeClass("active")});c("#edit-group-name").blur(function(){var a=c(this).val();60<a.length&&c(this).val(a.slice(0,59));c("#group-stats-name").html(c(this).val())});
c(".member:not(.active)").appendTo("#inactive-members");m.delegate("a.remove_member","click",function(a){a.preventDefault();c(this).parent(".member").removeClass("active").slideUp("fast",function(){c(this).appendTo("#inactive-members").find('input[type="checkbox"]').removeAttr("checked");r()})});var s=function(a){var b=c.map(c('li.member.active input[type="checkbox"]'),function(b){return b.value});return-1<c.inArray(a.id,b)},C=c(".buse-suggest-user").autocomplete({source:function(a,b){var d,e=a.term;
d=c.grep(buse_site_users,function(b){e=e.toLowerCase();return b.user.is_section_editor&&(-1!=b.user.display_name.toLowerCase().indexOf(e)||-1!=b.user.login.toLowerCase().indexOf(e)||-1!=b.user.nicename.toLowerCase().indexOf(e)||-1!=b.user.email.toLowerCase().indexOf(e))});d=c.grep(d,function(b){return!s(b.user)});d=c.map(d,function(b){return b.autocomplete});b(d)},delay:500,minLength:2,position:"undefined"!==typeof isRtl&&isRtl?{my:"right top",at:"right bottom",offset:"0, -1"}:{offset:"0, -1"},open:function(){c(this).addClass("open")},
close:function(){c(this).removeClass("open")}});c("#add_member").bind("click",function(c){c.preventDefault();t()});c("#user_login").keypress(function(c){"13"==c.keyCode&&(c.preventDefault(),t())});var n=function(a,b){"undefined"===typeof b&&(b="error");c("#members-message").attr("class",b).html("<p>"+a+"</p>").fadeIn()},t=function(){var a=c.trim(c("#user_login").val());if(a){C.autocomplete("search","");var b;b=c.grep(buse_site_users,function(b){var c=a.toLowerCase();return b.user.display_name.toLowerCase()==
c||b.user.login.toLowerCase()==c||b.user.nicename.toLowerCase()==c||b.user.email.toLowerCase()==c});b=1<b.length||0==b.length?!1:b[0].user;var d=buse_config.usersUrl;b?b.is_section_editor?s(b)?n("<b>"+b.display_name+"</b> is already a member of this group."):(c("#members-message").fadeOut("fast",function(){c(this).attr("class","").html("")}),c("#member_"+b.id).attr("checked","checked").parent(".member").addClass("active").appendTo(m).slideDown("fast"),r()):(d+="?s="+b.login,n("<b>"+b.display_name+
'</b> is not a section editor.  Before you can assign them to a group, you must change their role to "Section Editor" on the <a href="'+d+'">users page</a>.')):(d=buse_config.userNewUrl,n("<b>"+a+'</b> is not a member of this site.  Please <a href="'+d+'">add them to your site</a> with the "Section Editor" role.'))}c("#user_login").val("").focus()},r=function(){var a=m.children(".member").length;c(".member-count").html(a)},z=function(a){var b=a.find(".perm-editor").first();if(b.hasClass("hierarchical")){var d=
b.data("post-type");u.json_data={ajax:{url:ajaxurl,type:"GET",cache:!1,data:function(b){return{action:"buse_render_post_list",group_id:c("#group_id").val(),post_type:d,query:{child_of:b.attr?b.attr("id").substr(1):0}}},success:function(b){return b.posts},error:function(){}}};b.bind("loaded.jstree",function(b,a){!0==c.browser.msie&&8>parseInt(c.browser.version,10)||c(this).find("ul > .jstree-closed").each(function(){a.inst.load_node(c(this),function(){},function(){})})}).bind("load_node.jstree",function(b,
c){-1!=c.rslt.obj&&v(c.rslt.obj)}).bind("select_node.jstree",function(c,a){a.inst.is_selected(a.rslt.obj)&&w(a.rslt.obj,b)}).bind("deselect_node.jstree",function(){j(b)}).bind("deselect_all.jstree",function(){j(b)}).bind("overlay_clicked.buse",function(){b.jstree("get_selected").each(function(){var a=c(this),d=x(a);o(d,c(this),b);b.jstree("deselect_node",a)})}).jstree(u);b.closest(".perm-panel").bind("click",function(a){!c(a.target).hasClass("jstree-clicked")&&!c(a.target).parents(".jstree-clicked").length&&
b.jstree("get_selected").length&&b.jstree("deselect_all")})}else{var e=b.data("post-type");b.delegate("a","click",function(a){a.preventDefault();a.stopPropagation();$post=c(this).parent("li").first();$post.siblings("li.perm-item-selected").each(function(){c(this).removeClass("perm-item-selected");b.trigger("deselect_post.buse",{post:c(this)})});$post.addClass("perm-item-selected");b.trigger("select_post.buse",{post:$post})});b.closest(".perm-panel").bind("click",function(){b.trigger("deselect_all.buse")});
b.bind("posts_loaded.buse",function(){var a=c(this).siblings("input.buse-edits").first();if(0!==a.val().length)for(post_id in a=JSON.parse(a.val()),a){var d=b.find("#p"+post_id);d.length&&d.attr("rel",a[post_id])}}).bind("select_post.buse",function(c,a){w(a.post,b)}).bind("deselect_all.buse",function(){j(b)}).bind("overlay_clicked.buse",function(){b.find(".perm-item-selected").each(function(){var a=c(this),d=x(a);o(d,a,b);c(this).removeClass("perm-item-selected")})});p(b,{post_type:e})}a.delegate("button.perm-search",
"click",function(a){a.preventDefault();a=b.data("post-type");a=c("#perm-search-"+a).val();a={post_type:b.data("post-type"),query:{s:a}};j(b);p(b,a)});a.find(".pagination-links").delegate("a","click",function(a){a.preventDefault();if(!c(this).hasClass("disabled")){var a=c(this).attr("class"),d=parseInt(c(this).parent().find(".current-page").val()),e=parseInt(c(this).parent().find(".total-pages").text()),g=1;switch(a){case "first-page":g=1;break;case "prev-page":g=d-1;break;case "next-page":g=d+1;break;
case "last-page":g=e}y(g,b)}});a.delegate("input.current-page","keypress",function(a){if("13"==a.keyCode){a.preventDefault();var a=c(this).val(),d=parseInt(c(this).parent().find(".total-pages").text());1>a?c(this).val(1):a>d&&c(this).val(d);a=c(this).val();y(a,b)}});a.delegate("input.perm-search","keypress",function(a){13==a.keyCode&&(a.preventDefault(),c(this).siblings("button").first().click())});a.delegate("a.perm-editor-bulk-edit","click",function(b){b.preventDefault();a.addClass("bulk-edit")});
a.delegate("a.bulk-edit-close","click",function(b){b.preventDefault();a.removeClass("bulk-edit")});a.delegate(".bulk-edit-select-all","click",function(){b.find('input[type="checkbox"]').attr("checked",this.checked)});a.delegate(".bulk-edit-actions button","click",function(d){d.preventDefault();var d=c(this).siblings("select"),e=d.val(),h=b.find('input[type="checkbox"]:checked');0<h.length&&("allowed"==e||"denied"==e)&&h.each(function(){var a=c(this).parents("li");a.attr("rel",e);o(e,a,b)});a.find(".bulk-edit-select-all").attr("checked",
!1);d.val("none");h.attr("checked",!1)});a.delegate("a.perm-tree-expand","click",function(a){a.preventDefault();c.jstree._reference(b).open_all()});a.delegate("a.perm-tree-collapse","click",function(a){a.preventDefault();c.jstree._reference(b).close_all()});c('<span class="buse-overlay inactive"></span>').html('<a href="#" class="buse-action"><ins class="buse-icon">&nbsp;</ins></a>').insertAfter(b).delegate(".buse-action","click",function(a){a.stopPropagation();a.preventDefault();j(b);b.trigger("overlay_clicked.buse")});
a.addClass("loaded")};c("#perm-tab-container").delegate("a","click",function(){var a=c(c(this).attr("href"));a.hasClass("loaded")||z(a)});var y=function(a,b){var d=b.closest(".perm-panel"),e=b.data("post-type"),f={post_type:e,query:{paged:a}},e=c("#perm-search-"+e).val();0<e.length&&(f.query.s=e);j(b);d.find(".bulk-edit-select-all").attr("checked",!1);d.find(".bulk-edit-actions select").val("none");p(b,f)},D={allowed:{label:"Deny Editing","class":"allowed"},"allowed-desc-denied":{label:"Deny Editing",
"class":"allowed"},"allowed-desc-unknown":{label:"Deny Editing","class":"allowed"},denied:{label:"Allow Editing","class":"denied"},"denied-desc-allowed":{label:"Allow Editing","class":"denied"},"denied-desc-unknown":{label:"Allow Editing","class":"denied"}},w=function(a,b){var d=a.attr("rel"),e=a.children("a:first").first(),f=c("#perm-panel-container"),i=b.siblings(".buse-overlay").first(),d=D[d];"undefined"!=typeof d&&(e={of:e,my:"left center",at:"right center",within:f,offset:"15 0",collision:"fit none"},
i.find(".buse-action").html('<ins class="buse-icon">&nbsp;</ins> '+d.label),i.removeClass("inactive allowed allowed-desc-denied denied denied-desc-allowed").addClass(d["class"]).position(e))},j=function(a){a.siblings(".buse-overlay").removeClass("allowed allowed-desc-denied denied denied-desc-allowed").addClass("inactive")[0].removeAttribute("style")},u={plugins:["themes","types","json_data","ui"],core:{animation:0,html_titles:!0},themes:{theme:"classic"},types:{types:{"default":{clickable:!0,renameable:!1,
deletable:!1,creatable:!1,draggable:!1,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:buse_config.pluginUrl+"/images/group_perms_sprite.png",position:"-60px 0"}},denied:{clickable:!0,renameable:!1,deletable:!1,creatable:!1,draggable:!1,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:buse_config.pluginUrl+"/images/group_perms_sprite.png",position:"-60px 0"}},"denied-desc-allowed":{clickable:!0,renameable:!1,deletable:!1,creatable:!1,draggable:!1,max_children:-1,max_depth:-1,
valid_children:"all",icon:{image:buse_config.pluginUrl+"/images/group_perms_sprite.png",position:"2px 0"}},"denied-desc-unknown":{clickable:!0,renameable:!1,deletable:!1,creatable:!1,draggable:!1,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:buse_config.pluginUrl+"/images/group_perms_sprite.png",position:"-100px 0"}},allowed:{clickable:!0,renameable:!1,deletable:!1,creatable:!1,draggable:!1,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:buse_config.pluginUrl+"/images/group_perms_sprite.png",
position:"-40px 0"}},"allowed-desc-denied":{clickable:!0,renameable:!1,deletable:!1,creatable:!1,draggable:!1,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:buse_config.pluginUrl+"/images/group_perms_sprite.png",position:"-20px 0"}},"allowed-desc-unknown":{clickable:!0,renameable:!1,deletable:!1,creatable:!1,draggable:!1,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:buse_config.pluginUrl+"/images/group_perms_sprite.png",position:"-120px 0"}}}},ui:{select_limit:1}},p=
function(a,b){var d={action:"buse_render_post_list",group_id:c("#group_id").val(),query:{}};void 0!==typeof b&&c.extend(d,b);a.addClass("loading");d.query.offset?a.append('<span class="loader">Loading...</span>'):a.html('<span class="loader">Loading...</span>');c.ajax({url:ajaxurl,type:"GET",data:d,cache:!1,success:function(b){d.query.offset?a.append(b.posts):a.html(b.posts);var f=b.page,i=b.found_posts,h=b.max_num_pages,g=a.data("post-type");c("#group_id").val();$pagination=c("#perm-editor-pagination-"+
g);$total_items=$pagination.find(".displaying-num");$current_page=$pagination.find(".current-page");$total_pages=$pagination.find(".total-pages");$first_page=$pagination.find(".first-page");$prev_page=$pagination.find(".prev-page");$next_page=$pagination.find(".next-page");$last_page=$pagination.find(".last-page");g=1==parseInt(i)?" item":" items";$total_items.text(i+g);$current_page.val(f);$total_pages.text(h);1==f?($first_page.addClass("disabled"),$prev_page.addClass("disabled")):($first_page.removeClass("disabled"),
$prev_page.removeClass("disabled"));f==h?($next_page.addClass("disabled"),$last_page.addClass("disabled")):($next_page.removeClass("disabled"),$last_page.removeClass("disabled"));a.trigger("posts_loaded.buse",{posts:b.posts});a.removeClass("loading")},error:function(){}})},o=function(a,b,d){b.attr("rel",a);if(d.hasClass("hierarchical")){var e=c.jstree._reference(d);b.hasClass("jstree-closed")?e.open_node(b,function(){e.open_all(b);q(a,b,d)}):q(a,b,d)}d.hasClass("flat")&&q(a,b,d)},x=function(a){a=
a.data("perm");return"allowed"==a?"denied":"denied"==a?"allowed":"denied"},q=function(a,b,d){var e=b.attr("id").substr(1),f=d.data("post-type"),i,h=c("#buse-edits-"+f).val()||"";i=h?JSON.parse(h):{};var g=0;prev_state=b.data("perm");b.data("perm",a);i[e]=a;prev_state!=a&&(g="allowed"==a?g+1:g-1);d.hasClass("hierarchical")&&(b.find("li").each(function(b,d){var e=c(d).data("perm"),f=c(this).attr("id").substr(1);e!=a&&(c(d).data("perm",a),i[f]=a,g="allowed"==a?g+1:g-1);c(d).attr("rel",a)}),$root_post=
b.parentsUntil("#"+d.attr("id"),"li").last(),$root_post.length&&v($root_post));c("#buse-edits-"+f).val(JSON.stringify(i));d=g;c("#group-stats-permissions");e=c("#"+f+"-stats");b=c("#"+f+"-pending-diff");h=0;0==b.length&&(b=c('<span id="'+f+'-pending-diff" class="perm-stats-diff" data-count="0"></span>').appendTo(e));h=parseInt(b.data("count"));f=h+d;d="";0<f?(d=" ( +"+f+" )",b.removeClass("negative").addClass("positive")):0>f?(d=" ( "+f+" )",b.removeClass("positive").addClass("negative")):b.removeClass("positive negative");
b.data("count",f).text(d)},v=function(a){$sections=a.find("ul");$sections.each(function(){var a=c(this).parents("li").first();if(a.length){var d=!1;switch(a.attr("rel")){case "allowed":case "allowed-desc-denied":case "allowed-desc-unknown":(d=0<c(this).find('li[rel="denied"],li[rel="denied-desc-allowed"],li[rel="denied-desc-unknown"]').length)?a.attr("rel","allowed-desc-denied"):a.attr("rel","allowed");break;case "denied":case "denied-desc-allowed":case "denied-desc-unknown":(d=0<c(this).find('li[rel="allowed"],li[rel="allowed-desc-denied"],li[rel="allowed-desc-unknown"]').length)?
a.attr("rel","denied-desc-allowed"):a.attr("rel","denied")}}})},A,k;A=c("#edit-group-name").val();var B=function(){var a=[];c("#group-member-list").children("li.member.active").each(function(b,d){a.push(c(d).children("input").first().val())});return a};k=B();window.onbeforeunload=function(){if(E())return"Your group has pending edits.  If you leave now, your changes will be lost."};var E=function(){if(A!=c("#edit-group-name").val())return!0;var a=B();if(k.length!=a.length)return!0;for(index in k)if(-1==
c.inArray(k[index],a))return!0;var b=!1;c(".buse-edits").each(function(a,e){c(e).val()&&(b=!0)});return b};c("#group-edit-form").submit(function(){window.onbeforeunload=null;if(1>c("#edit-group-name").val().length){var a=c("#message");a.length?(a.attr("class","error"),a.html("<p>Please give your group a name before saving.</p>")):(a=c('<div id="message" class="error">'),a.html("<p>Please give your group a name before saving.</p>"),c(".form-wrap").before(a));return!1}});c("a.submitdelete").click(function(a){a.preventDefault();
confirm("You are about to permanently delete this section editing group.  This action is irreversible.\n\nAre you sure you want to do this?")&&(window.onbeforeunload=null,window.location=c(this).attr("href"))});if(document.images){var l=new Image,F=new Image;l.src=buse_config.pluginUrl+"/images/group_perms_sprite.png";F.src=buse_config.pluginUrl+"/images/loading.gif"}l=c("#perm-panel-container").find(".perm-panel.active").first();l.length&&z(l)});